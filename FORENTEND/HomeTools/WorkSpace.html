<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../CSSPAge/WorkSpacePage.css" rel="stylesheet">
    <script src="../js/task-api.js"></script>
    <title>Todo List - WorkSpace</title>
</head>

<body>
    <!-- Sidebar with navigation icons -->
    <div class="SiderBar">
        <img class="nav-icon" src="https://img.icons8.com/3d-fluency/375/home.png" alt="home" title="Home" onclick="navigateTo('Home.html')" />
        <img class="nav-icon active" src="https://img.icons8.com/cute-clipart/64/overtime.png" alt="tasks" title="WorkSpace" onclick="navigateTo('WorkSpace.html')" />
        <img class="nav-icon" src="https://img.icons8.com/3d-fluency/94/tear-off-calendar.png" alt="calendar" title="Schedule" onclick="navigateTo('Schedule.html')" />
        <img class="nav-icon" src="https://img.icons8.com/3d-fluency/94/gear--v1.png" alt="settings" title="Settings" onclick="navigateTo('Settings.html')" />
    </div>

    <!-- Main content area -->
    <div class="main-content">
        <div class="header">
            <h1>‚ö° WorkSpace</h1>
            <p>Organize your projects and boost your productivity!</p>
            <div class="header-actions">
                <div class="search-container">
                    <input type="text" placeholder="üîç Search tasks..." id="searchInput" class="search-input">
                </div>
                <div class="view-toggle">
                    <button class="toggle-btn active" id="boardView">üìã Board</button>
                    <button class="toggle-btn" id="listView">üìù List</button>
                    <button class="toggle-btn" id="timelineView">üìä Timeline</button>
                </div>
            </div>
        </div>
        
        <div class="workspace-container">
            <!-- Quick Actions Panel -->
            <div class="quick-actions">
                <button class="quick-btn" id="addTaskBtn">
                    <span class="btn-icon">‚ûï</span>
                    <span class="btn-text">Add Task</span>
                </button>
                <button class="quick-btn" id="addProjectBtn">
                    <span class="btn-icon">üìÅ</span>
                    <span class="btn-text">New Project</span>
                </button>
                <button class="quick-btn" id="timerBtn">
                    <span class="btn-icon">‚è±Ô∏è</span>
                    <span class="btn-text">Start Timer</span>
                </button>
                <button class="quick-btn" id="reportBtn">
                    <span class="btn-icon">üìà</span>
                    <span class="btn-text">Reports</span>
                </button>
                <!-- Delete Zone (appears when dragging) -->
                <div class="quick-btn delete-zone" id="deleteZone" style="display: none;">
                    <span class="btn-icon">üóëÔ∏è</span>
                    <span class="btn-text">Drop to Delete</span>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-state-illustration">
                    <img src="./NOTaskImage.jpg" alt="No tasks yet" class="empty-illustration">
                </div>
                <div class="empty-state-content">
                    <h2><span class="emoji"">üöÄ</span> Ready to be productive?</h2>
                    <p>You don't have any tasks yet. Create your first task and start organizing your workflow!</p>
                    <button class="cta-button" onclick="openTaskModal('todo')">
                        <span class="cta-icon">‚ú®</span>
                        <span class="cta-text">Create Your First Task</span>
                    </button>
                </div>
            </div>

            <!-- Board View (Default) -->
            <div class="view-container" id="boardContainer" style="display: none;">
                <div class="project-board">
                    <div class="board-column" data-status="todo">
                        <div class="column-header">
                            <div class="column-title">
                                <span class="column-icon">üìã</span>
                                <h3>To Do</h3>  
                            </div>
                            <div class="column-actions">
                                <span class="task-count" id="todoCount">0</span>
                                <button class="column-menu-btn">‚ãØ</button>
                            </div>
                        </div>
                        <div class="task-list" id="todoColumn" ondrop="dropTask(event)" ondragover="allowDrop(event)">
                            <!-- Tasks will be dynamically added here -->
                        </div>
                        <button class="add-task-btn" onclick="openTaskModal('todo')">
                            <span class="add-icon">+</span>
                            <span class="add-text">Add Task</span>
                        </button>
                    </div>

                    <div class="board-column" data-status="progress">
                        <div class="column-header">
                            <div class="column-title">
                                <span class="column-icon">üîÑ</span>
                                <h3>In Progress</h3>
                            </div>
                            <div class="column-actions">
                                <span class="task-count" id="progressCount">0</span>
                                <button class="column-menu-btn">‚ãØ</button>
                            </div>
                        </div>
                        <div class="task-list" id="progressColumn" ondrop="dropTask(event)" ondragover="allowDrop(event)">
                            <!-- Tasks will be dynamically added here -->
                        </div>
                        <button class="add-task-btn" onclick="openTaskModal('progress')">
                            <span class="add-icon">+</span>
                            <span class="add-text">Add Task</span>
                        </button>
                    </div>

                    <div class="board-column" data-status="review">
                        <div class="column-header">
                            <div class="column-title">
                                <span class="column-icon">üëÄ</span>
                                <h3>Review</h3>
                            </div>
                            <div class="column-actions">
                                <span class="task-count" id="reviewCount">0</span>
                                <button class="column-menu-btn">‚ãØ</button>
                            </div>
                        </div>
                        <div class="task-list" id="reviewColumn" ondrop="dropTask(event)" ondragover="allowDrop(event)">
                            <!-- Tasks will be dynamically added here -->
                        </div>
                        <button class="add-task-btn" onclick="openTaskModal('review')">
                            <span class="add-icon">+</span>
                            <span class="add-text">Add Task</span>
                        </button>
                    </div>

                    <div class="board-column" data-status="completed">
                        <div class="column-header">
                            <div class="column-title">
                                <span class="column-icon">‚úÖ</span>
                                <h3>Completed</h3>
                            </div>
                            <div class="column-actions">
                                <span class="task-count" id="completedCount">0</span>
                                <button class="column-menu-btn">‚ãØ</button>
                            </div>
                        </div>
                        <div class="task-list" id="completedColumn" ondrop="dropTask(event)" ondragover="allowDrop(event)">
                            <!-- Tasks will be dynamically added here -->
                        </div>
                        <button class="add-task-btn" onclick="openTaskModal('completed')">
                            <span class="add-icon">+</span>
                            <span class="add-text">Add Task</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Statistics Dashboard -->
            <div class="workspace-stats">
                <div class="stat-widget">
                    <h3>üìä Project Overview</h3>
                    <div class="progress-container">
                        <div class="circular-progress" data-percent="0">
                            <div class="progress-circle-bg">
                                <div class="progress-circle-fill"></div>
                                <div class="progress-text">0%</div>
                            </div>
                        </div>
                        <div class="progress-details">
                            <p><strong>0 Total Tasks</strong></p>
                            <p>0 Completed ‚Ä¢ 0 In Progress</p>
                            <p>Ready to start!</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-widget">
                    <h3>‚è∞ Time Analytics</h3>
                    <div class="time-stats">
                        <div class="time-item">
                            <span class="time-label">Today</span>
                            <span class="time-value">0h 0m</span>
                            <div class="time-bar">
                                <div class="time-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="time-item">
                            <span class="time-label">This Week</span>
                            <span class="time-value">0h 0m</span>
                            <div class="time-bar">
                                <div class="time-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="time-item">
                            <span class="time-label">Average/Day</span>
                            <span class="time-value">0h 0m</span>
                            <div class="time-bar">
                                <div class="time-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-widget">
                    <h3>üéØ Performance Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <span class="metric-icon">üèÉ</span>
                            <span class="metric-value">--</span>
                            <span class="metric-label">On Time</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-icon">‚≠ê</span>
                            <span class="metric-value">--</span>
                            <span class="metric-label">Quality</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-icon">üöÄ</span>
                            <span class="metric-value">--</span>
                            <span class="metric-label">Velocity</span>
                        </div>
                    </div>
                </div>

                <div class="stat-widget">
                    <h3>üìà Team Activity</h3>
                    <div class="activity-timeline">
                        <div class="empty-activity">
                            <span class="empty-activity-icon">üì≠</span>
                            <span class="empty-activity-text">No recent activity</span>
                            <span class="empty-activity-desc">Start creating tasks to see activity here</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModalOverlay">
        <div class="task-modal" id="taskModal">
            <div class="modal-header">
                <h3 id="modalTitle">Create New Task</h3>
                <button class="close-modal" onclick="closeTaskModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="taskTitleInput">Task Title</label>
                    <input type="text" id="taskTitleInput" placeholder="Enter task title..." class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskDescInput">Description</label>
                    <textarea id="taskDescInput" placeholder="Enter task description..." class="form-textarea"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskPrioritySelect">Priority</label>
                        <select id="taskPrioritySelect" class="form-select">
                            <option value="low">Low Priority</option>
                            <option value="medium" selected>Medium Priority</option>
                            <option value="high">High Priority</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskDueDateInput">Due Date</label>
                        <input type="date" id="taskDueDateInput" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskTagsInput">Tags</label>
                    <input type="text" id="taskTagsInput" placeholder="Enter tags separated by commas..." class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskAssigneeSelect">Assignee</label>
                    <select id="taskAssigneeSelect" class="form-select">
                        <option value="John Doe">John Doe</option>
                        <option value="Jane Smith">Jane Smith</option>
                        <option value="Mike Johnson">Mike Johnson</option>
                        <option value="Alex Wilson">Alex Wilson</option>
                        <option value="Sarah Davis">Sarah Davis</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeTaskModal()">Cancel</button>
                <button type="button" class="btn-create" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Timer Widget -->
    <div class="timer-widget" id="timerWidget">
        <div class="timer-display">
            <span class="timer-time" id="timerDisplay">00:00:00</span>
            <button class="timer-control" id="timerControl" onclick="toggleTimer()">‚ñ∂Ô∏è</button>
        </div>
        <div class="timer-task">
            <span id="timerTaskName">No task selected</span>
        </div>
        <button class="timer-close" onclick="closeTimer()">‚úï</button>
    </div>

    <script>
        // Global variables
        let taskIdCounter = 1;
        let draggedElement = null;
        let currentTaskStatus = 'todo';
        let timerRunning = false;
        let timerSeconds = 0;
        let timerInterval = null;
        let currentTimerTask = null;
        let totalTasks = 0;
        let taskManager = null;

        // Navigation function
        function navigateTo(page) {
            window.location.href = page;
        }

        // View Toggle Functions
        function initializeViewToggle() {
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            const boardContainer = document.getElementById('boardContainer');

            toggleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');

                    // Handle view switching
                    const viewType = btn.id;
                    switchView(viewType);
                });
            });
        }

        function switchView(viewType) {
            switch(viewType) {
                case 'boardView':
                    // Use checkEmptyState to properly show empty state or board based on task count
                    checkEmptyState();
                    break;
                case 'listView':
                    // Add list view implementation here
                    showNotification('List view coming soon!', 'info');
                    break;
                case 'timelineView':
                    // Add timeline view implementation here
                    showNotification('Timeline view coming soon!', 'info');
                    break;
            }
        }

        // Search Functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterTasks(searchTerm);
            });
        }

        function filterTasks(searchTerm) {
            const taskCards = document.querySelectorAll('.task-card');
            
            taskCards.forEach(card => {
                const title = card.querySelector('h4').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase()).join(' ');
                
                const matches = title.includes(searchTerm) || description.includes(searchTerm) || tags.includes(searchTerm);
                
                if (matches || searchTerm === '') {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Quick Actions
        function initializeQuickActions() {
            document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal('todo'));
            document.getElementById('addProjectBtn').addEventListener('click', () => showNotification('Project management coming soon!', 'info'));
            document.getElementById('timerBtn').addEventListener('click', () => showTimer());
            document.getElementById('reportBtn').addEventListener('click', () => showNotification('Reports feature coming soon!', 'info'));
        }

        // Drag and Drop Functions
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function dragTask(ev) {
            draggedElement = ev.target;
            ev.dataTransfer.effectAllowed = "move";
            ev.dataTransfer.setData("text/plain", ev.target.dataset.taskId);
            ev.target.classList.add('dragging');
            
            // Show delete zone with animation
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.style.display = 'flex';
                setTimeout(() => {
                    deleteZone.classList.add('active');
                }, 10);
            }
            
            // Remove drag-over class from all columns
            document.querySelectorAll('.task-list').forEach(list => {
                list.classList.remove('drag-over');
            });
        }

        async function dropTask(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            // Hide delete zone
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.classList.remove('active');
                setTimeout(() => {
                    deleteZone.style.display = 'none';
                }, 300);
            }
            
            if (draggedElement) {
                const targetList = ev.currentTarget;
                const targetColumn = targetList.closest('.board-column');
                const newStatus = targetColumn.dataset.status;
                const taskId = draggedElement.dataset.taskId; // Keep as string for MongoDB ObjectId
                
                try {
                    // Get current task data
                    const allTasks = await taskManager.getTasks();
                    const currentTask = allTasks.find(t => t.id == taskId);
                    
                    if (currentTask) {
                        // Update task with new status
                        const updatedTask = { ...currentTask, status: newStatus };
                        await taskManager.updateTask(taskId, updatedTask);
                    }
                    
                    // Move the task in UI
                    targetList.appendChild(draggedElement);
                    
                    // Update task status styling
                    updateTaskStatus(draggedElement, newStatus);
                    
                    // Update counts and stats
                    updateTaskCounts();
                    updateProjectStats();
                    
                    // Add animation
                    draggedElement.classList.add('task-dropped');
                    setTimeout(() => {
                        draggedElement.classList.remove('task-dropped', 'dragging');
                    }, 300);
                    
                    showNotification('Task moved successfully!', 'success');
                } catch (error) {
                    console.error('Failed to update task status:', error);
                    showNotification('Failed to move task. Please try again.', 'error');
                }
                
                draggedElement = null;
            }
        }
        
        // Add dragend event to hide delete zone
        function handleDragEnd(ev) {
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.classList.remove('active');
                setTimeout(() => {
                    deleteZone.style.display = 'none';
                }, 300);
            }
            
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            
            document.querySelectorAll('.task-list').forEach(list => {
                list.classList.remove('drag-over');
            });
        }
        
        // Delete zone drop handler
        function dropOnDeleteZone(ev) {
            ev.preventDefault();
            const deleteZone = document.getElementById('deleteZone');
            
            if (draggedElement && deleteZone) {
                const taskId = draggedElement.dataset.taskId;
                
                // Animate deletion
                draggedElement.style.transform = 'scale(0) rotate(180deg)';
                draggedElement.style.opacity = '0';
                deleteZone.classList.add('deleting');
                
                setTimeout(async () => {
                    try {
                        await taskManager.deleteTask(taskId);
                        draggedElement.remove();
                        updateTaskCounts();
                        updateProjectStats();
                        checkEmptyState();
                        showNotification('Task deleted successfully!', 'success');
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        showNotification('Failed to delete task', 'error');
                        draggedElement.style.transform = '';
                        draggedElement.style.opacity = '';
                    }
                    
                    deleteZone.classList.remove('active', 'deleting');
                    deleteZone.style.display = 'none';
                    draggedElement = null;
                }, 300);
            }
        }
        
        // Allow drop on delete zone
        function allowDropOnDeleteZone(ev) {
            ev.preventDefault();
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.classList.add('drag-over-delete');
            }
        }
        
        function dragLeaveDeleteZone(ev) {
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.classList.remove('drag-over-delete');
            }
        }

        function updateTaskStatus(taskElement, status) {
            // Remove all status classes
            taskElement.classList.remove('in-progress', 'review', 'completed');
            
            // Add new status class
            if (status === 'progress') {
                taskElement.classList.add('in-progress');
            } else if (status === 'review') {
                taskElement.classList.add('review');
            } else if (status === 'completed') {
                taskElement.classList.add('completed');
                
                // Update progress to 100%
                const progressCircle = taskElement.querySelector('.progress-circle');
                const progressText = taskElement.querySelector('.progress-text');
                if (progressCircle && progressText) {
                    progressCircle.dataset.progress = '100';
                    progressText.textContent = '‚úì';
                    progressCircle.classList.add('completed');
                }
            }
        }

        // Task Modal Functions
        function openTaskModal(status = 'todo') {
            console.log('Opening task modal for status:', status); // Debug log
            currentTaskStatus = status;
            
            const modalOverlay = document.getElementById('taskModalOverlay');
            const titleInput = document.getElementById('taskTitleInput');
            
            if (!modalOverlay || !titleInput) {
                console.error('Modal elements not found');
                showNotification('Error opening task modal', 'error');
                return;
            }
            
            modalOverlay.style.display = 'flex';
            titleInput.focus();
            
            // Set current date as default due date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dueDateInput = document.getElementById('taskDueDateInput');
            if (dueDateInput) {
                dueDateInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            // Update modal title based on status
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) {
                const statusText = {
                    'todo': 'To Do',
                    'progress': 'In Progress', 
                    'review': 'Review',
                    'completed': 'Completed'
                };
                modalTitle.textContent = `Create New Task - ${statusText[status] || 'To Do'}`;
            }
        }

        function closeTaskModal() {
            const modalOverlay = document.getElementById('taskModalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
            }
            
            // Reset button state
            const createBtn = document.querySelector('.btn-create');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.classList.remove('loading');
            }
            
            clearModalForm();
        }

        function clearModalForm() {
            try {
                const titleInput = document.getElementById('taskTitleInput');
                const descInput = document.getElementById('taskDescInput');
                const prioritySelect = document.getElementById('taskPrioritySelect');
                const tagsInput = document.getElementById('taskTagsInput');
                const assigneeSelect = document.getElementById('taskAssigneeSelect');
                const dueDateInput = document.getElementById('taskDueDateInput');
                
                if (titleInput) titleInput.value = '';
                if (descInput) descInput.value = '';
                if (prioritySelect) prioritySelect.value = 'medium';
                if (tagsInput) tagsInput.value = '';
                if (assigneeSelect) assigneeSelect.selectedIndex = 0;
                if (dueDateInput) dueDateInput.value = '';
                
                // Remove any error styling
                [titleInput, descInput].forEach(input => {
                    if (input) {
                        input.classList.remove('error');
                        input.style.borderColor = '';
                    }
                });
            } catch (error) {
                console.error('Error clearing form:', error);
            }
        }

        async function createTask(event) {
            // Prevent any default form submission or navigation
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Create task function called'); // Debug log
            
            // Prevent double submission
            const createBtn = document.querySelector('.btn-create');
            if (createBtn && createBtn.disabled) {
                console.log('Button already disabled, preventing double submission');
                return;
            }
            
            try {
                // Add loading state
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.classList.add('loading');
                }
                
                const title = document.getElementById('taskTitleInput').value.trim();
                const description = document.getElementById('taskDescInput').value.trim();
                const priority = document.getElementById('taskPrioritySelect').value;
                const dueDate = document.getElementById('taskDueDateInput').value;
                const tagsInput = document.getElementById('taskTagsInput').value.trim();
                const assignee = document.getElementById('taskAssigneeSelect').value;

                console.log('Form values:', { title, description, priority, dueDate, tagsInput, assignee }); // Debug log

                // Validate required fields with visual feedback
                const titleInput = document.getElementById('taskTitleInput');
                const descInput = document.getElementById('taskDescInput');
                let hasErrors = false;

                // Reset previous error styling
                [titleInput, descInput].forEach(input => {
                    if (input) {
                        input.style.borderColor = '';
                        input.classList.remove('error');
                    }
                });

                if (!title) {
                    if (titleInput) {
                        titleInput.style.borderColor = '#dc3545';
                        titleInput.classList.add('error');
                    }
                    hasErrors = true;
                }

                if (!description) {
                    if (descInput) {
                        descInput.style.borderColor = '#dc3545';
                        descInput.classList.add('error');
                    }
                    hasErrors = true;
                }

                if (hasErrors) {
                    // Remove loading state on error
                    if (createBtn) {
                        createBtn.disabled = false;
                        createBtn.classList.remove('loading');
                    }
                    
                    showNotification('Please fill in all required fields (Title and Description)!', 'error');
                    // Focus on first empty field
                    if (!title && titleInput) {
                        titleInput.focus();
                    } else if (!description && descInput) {
                        descInput.focus();
                    }
                    return;
                }

                // Process tags
                const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

                // Prepare task data for API
                const taskData = {
                    title,
                    description,
                    priority,
                    dueDate: dueDate || null,
                    tags,
                    assignee,
                    status: currentTaskStatus,
                    progress: 0
                };

                // Create task using TaskManager
                const newTask = await taskManager.createTask(taskData);
                console.log('Task created via API:', newTask);

                // Add task to UI
                await addTaskToUI(newTask);
                
                // Close modal and show success
                closeTaskModal();
                showNotification('Task created successfully! üéâ', 'success');
                
            } catch (error) {
                console.error('Error in createTask:', error);
                showNotification('Error creating task. Please try again.', 'error');
                
                // Remove loading state on error  
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.classList.remove('loading');
                }
            }
        }

        // UI Helper Functions
        async function addTaskToUI(task) {
            const formattedDueDate = task.dueDate ? 
                new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 
                'No due date';

            const taskHTML = `
                <div class="task-card" draggable="true" ondragstart="dragTask(event)" ondragend="handleDragEnd(event)" data-task-id="${task.id}">
                    <div class="task-delete-overlay">
                        <span class="delete-icon">üóëÔ∏è</span>
                        <span class="delete-text">Delete</span>
                    </div>
                    <div class="task-content">
                        <div class="task-header">
                            <h4 class="task-title-editable" onclick="editTaskTitle(event, ${task.id})">${task.title}</h4>
                        </div>
                        <p class="task-description-editable" onclick="editTaskDescription(event, ${task.id})">${task.description}</p>
                        ${task.tags && task.tags.length > 0 ? 
                            `<div class="task-tags">${task.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : 
                            ''
                        }
                        <div class="task-meta">
                            <span class="priority ${task.priority}" onclick="editTaskPriority(event, ${task.id})">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                            <span class="due-date" onclick="editTaskDueDate(event, ${task.id})">Due: ${formattedDueDate}</span>
                            <div class="task-progress">
                                <div class="progress-circle" data-progress="${task.progress || 0}">
                                    <span class="progress-text">${task.progress || 0}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-assignee">
                            <img src="https://via.placeholder.com/30" alt="User" class="avatar">
                            <span class="assignee-name">${task.assignee}</span>
                        </div>
                    </div>
                </div>
            `;

            const targetColumn = document.getElementById(task.status + 'Column');
            if (targetColumn) {
                targetColumn.insertAdjacentHTML('beforeend', taskHTML);
                
                // Add event listeners to new task
                const newTaskElement = targetColumn.querySelector(`[data-task-id="${task.id}"]`);
                if (newTaskElement) {
                    // Drag end event
                    newTaskElement.addEventListener('dragend', () => {
                        newTaskElement.classList.remove('dragging');
                        document.querySelectorAll('.task-list').forEach(list => {
                            list.classList.remove('drag-over');
                        });
                    });
                    
                    // Initialize swipe-to-delete
                    initializeSwipeToDelete(newTaskElement);
                }
            }

            // Update UI state
            checkEmptyState();
            updateTaskCounts();
            updateProjectStats();
        }

        async function loadAllTasks() {
            try {
                showNotification('Loading tasks...', 'info');
                await taskManager.loadTasks();
                
                // Clear all columns
                ['todo', 'progress', 'review', 'completed'].forEach(status => {
                    const column = document.getElementById(status + 'Column');
                    if (column) {
                        column.innerHTML = '';
                    }
                });

                // Add tasks to UI
                for (const task of taskManager.tasks) {
                    await addTaskToUI(task);
                }

                checkEmptyState();
                updateTaskCounts();
                updateProjectStats();
                
                showNotification(`Loaded ${taskManager.tasks.length} tasks`, 'success');
            } catch (error) {
                console.error('Failed to load tasks:', error);
                showNotification('Failed to load tasks. Working in offline mode.', 'warning');
                // Ensure empty state is shown when loading fails
                checkEmptyState();
            }
        }

        // Swipe to Delete Functionality
        function initializeSwipeToDelete(taskElement) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let deleteThreshold = -100; // Swipe left 100px to delete

            taskElement.addEventListener('touchstart', handleTouchStart, { passive: true });
            taskElement.addEventListener('touchmove', handleTouchMove, { passive: false });
            taskElement.addEventListener('touchend', handleTouchEnd);

            taskElement.addEventListener('mousedown', handleMouseDown);

            function handleTouchStart(e) {
                startX = e.touches[0].clientX;
                isDragging = true;
                taskElement.style.transition = 'none';
            }

            function handleMouseDown(e) {
                startX = e.clientX;
                isDragging = true;
                taskElement.style.transition = 'none';
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            }

            function handleTouchMove(e) {
                if (!isDragging) return;
                
                currentX = e.touches[0].clientX - startX;
                
                // Only allow left swipe
                if (currentX < 0) {
                    taskElement.style.transform = `translateX(${currentX}px)`;
                    
                    // Show delete overlay
                    const overlay = taskElement.querySelector('.task-delete-overlay');
                    if (overlay) {
                        const opacity = Math.min(Math.abs(currentX) / Math.abs(deleteThreshold), 1);
                        overlay.style.opacity = opacity;
                    }
                    
                    e.preventDefault();
                }
            }

            function handleMouseMove(e) {
                if (!isDragging) return;
                
                currentX = e.clientX - startX;
                
                // Only allow left swipe
                if (currentX < 0) {
                    taskElement.style.transform = `translateX(${currentX}px)`;
                    
                    // Show delete overlay
                    const overlay = taskElement.querySelector('.task-delete-overlay');
                    if (overlay) {
                        const opacity = Math.min(Math.abs(currentX) / Math.abs(deleteThreshold), 1);
                        overlay.style.opacity = opacity;
                    }
                }
            }

            function handleTouchEnd() {
                if (!isDragging) return;
                
                isDragging = false;
                taskElement.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                
                if (currentX <= deleteThreshold) {
                    // Delete the task
                    deleteTaskWithAnimation(taskElement);
                } else {
                    // Reset position
                    taskElement.style.transform = 'translateX(0)';
                    const overlay = taskElement.querySelector('.task-delete-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                    }
                }
                
                currentX = 0;
            }

            function handleMouseUp() {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                handleTouchEnd();
            }
        }

        async function deleteTaskWithAnimation(taskElement) {
            const taskId = taskElement.dataset.taskId;
            
            // Animate out
            taskElement.style.transform = 'translateX(-150%)';
            taskElement.style.opacity = '0';
            
            setTimeout(async () => {
                try {
                    const response = await taskManager.deleteTask(taskId);
                    
                    taskElement.remove();
                    updateTaskCounts();
                    updateProjectStats();
                    checkEmptyState();
                    showNotification('Task deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showNotification('Failed to delete task: ' + error.message, 'error');
                    
                    // Reset position on error
                    taskElement.style.transform = 'translateX(0)';
                    taskElement.style.opacity = '1';
                }
            }, 300);
        }

        // Inline Editing Functions
        function editTaskTitle(event, taskId) {
            event.stopPropagation();
            const titleElement = event.target;
            const currentTitle = titleElement.textContent;
            
            titleElement.contentEditable = true;
            titleElement.focus();
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(titleElement);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            
            titleElement.classList.add('editing');
            
            titleElement.addEventListener('blur', async () => {
                titleElement.contentEditable = false;
                titleElement.classList.remove('editing');
                const newTitle = titleElement.textContent.trim();
                
                if (newTitle && newTitle !== currentTitle) {
                    await updateTaskField(taskId, 'title', newTitle);
                } else {
                    titleElement.textContent = currentTitle;
                }
            }, { once: true });
            
            titleElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    titleElement.blur();
                } else if (e.key === 'Escape') {
                    titleElement.textContent = currentTitle;
                    titleElement.blur();
                }
            });
        }

        function editTaskDescription(event, taskId) {
            event.stopPropagation();
            const descElement = event.target;
            const currentDesc = descElement.textContent;
            
            descElement.contentEditable = true;
            descElement.focus();
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(descElement);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            
            descElement.classList.add('editing');
            
            descElement.addEventListener('blur', async () => {
                descElement.contentEditable = false;
                descElement.classList.remove('editing');
                const newDesc = descElement.textContent.trim();
                
                if (newDesc && newDesc !== currentDesc) {
                    await updateTaskField(taskId, 'description', newDesc);
                } else {
                    descElement.textContent = currentDesc;
                }
            }, { once: true });
            
            descElement.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    descElement.textContent = currentDesc;
                    descElement.blur();
                }
            });
        }

        function editTaskPriority(event, taskId) {
            event.stopPropagation();
            const priorityElement = event.target;
            const currentPriority = priorityElement.classList.contains('high') ? 'high' : 
                                   priorityElement.classList.contains('medium') ? 'medium' : 'low';
            
            // Cycle through priorities
            const priorities = ['low', 'medium', 'high'];
            const currentIndex = priorities.indexOf(currentPriority);
            const newPriority = priorities[(currentIndex + 1) % 3];
            
            priorityElement.className = `priority ${newPriority}`;
            priorityElement.textContent = newPriority.charAt(0).toUpperCase() + newPriority.slice(1);
            
            updateTaskField(taskId, 'priority', newPriority);
        }

        function editTaskDueDate(event, taskId) {
            event.stopPropagation();
            const dueDateElement = event.target;
            
            // Create date picker input
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'inline-date-picker';
            
            // Get current date
            const currentText = dueDateElement.textContent.replace('Due: ', '');
            if (currentText !== 'No due date') {
                const date = new Date(currentText);
                input.value = date.toISOString().split('T')[0];
            }
            
            dueDateElement.replaceWith(input);
            input.focus();
            
            input.addEventListener('change', async () => {
                const newDate = input.value;
                const formattedDate = new Date(newDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const newSpan = document.createElement('span');
                newSpan.className = 'due-date';
                newSpan.textContent = `Due: ${formattedDate}`;
                newSpan.onclick = (e) => editTaskDueDate(e, taskId);
                
                input.replaceWith(newSpan);
                
                await updateTaskField(taskId, 'dueDate', newDate);
            });
            
            input.addEventListener('blur', () => {
                const newSpan = document.createElement('span');
                newSpan.className = 'due-date';
                newSpan.textContent = dueDateElement.textContent || 'Due: No due date';
                newSpan.onclick = (e) => editTaskDueDate(e, taskId);
                
                input.replaceWith(newSpan);
            }, { once: true });
        }

        async function updateTaskField(taskId, field, value) {
            try {
                // Get current task data
                const allTasks = await taskManager.getTasks();
                const currentTask = allTasks.find(t => t.id == taskId);
                
                if (!currentTask) {
                    throw new Error('Task not found');
                }
                
                // Update the field
                const updatedTask = { ...currentTask, [field]: value };
                
                await taskManager.updateTask(taskId, updatedTask);
                
                showNotification(`Task ${field} updated successfully`, 'success');
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Failed to update task: ' + error.message, 'error');
            }
        }

        // Task Management Functions (Legacy - kept for compatibility)
        function editTask(taskId) {
            // Inline editing is now the default
            showNotification('Click on any field to edit', 'info');
        }

        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskElement) {
                        taskElement.style.animation = 'slideOut 0.3s ease-out';
                        
                        // Delete from API
                        await taskManager.deleteTask(taskId);
                        
                        setTimeout(() => {
                            taskElement.remove();
                            updateTaskCounts();
                            updateProjectStats();
                            checkEmptyState();
                            showNotification('Task deleted successfully!', 'success');
                        }, 300);
                    }
                } catch (error) {
                    console.error('Failed to delete task:', error);
                    showNotification('Failed to delete task. Please try again.', 'error');
                }
            }
        }

        // Check if we should show empty state or board
        function checkEmptyState() {
            const allTasks = document.querySelectorAll('.task-card');
            const emptyState = document.getElementById('emptyState');
            const boardContainer = document.getElementById('boardContainer');
            
            if (allTasks.length === 0) {
                emptyState.style.display = 'flex';
                boardContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                boardContainer.style.display = 'block';
            }
        }

        // Update task counts
        function updateTaskCounts() {
            const columns = [
                { id: 'todoColumn', countId: 'todoCount' },
                { id: 'progressColumn', countId: 'progressCount' },
                { id: 'reviewColumn', countId: 'reviewCount' },
                { id: 'completedColumn', countId: 'completedCount' }
            ];
            
            totalTasks = 0;
            columns.forEach(({ id, countId }) => {
                const column = document.getElementById(id);
                const taskCount = column.querySelectorAll('.task-card').length;
                const countElement = document.getElementById(countId);
                if (countElement) {
                    countElement.textContent = taskCount;
                }
                totalTasks += taskCount;
            });
        }

        // Update project statistics
        function updateProjectStats() {
            const completedTasks = document.querySelectorAll('#completedColumn .task-card').length;
            const inProgressTasks = document.querySelectorAll('#progressColumn .task-card').length;
            const reviewTasks = document.querySelectorAll('#reviewColumn .task-card').length;
            const todoTasks = document.querySelectorAll('#todoColumn .task-card').length;
            
            // Update progress percentage
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const progressCircle = document.querySelector('.circular-progress');
            const progressText = document.querySelector('.progress-text');
            
            if (progressCircle && progressText) {
                progressCircle.dataset.percent = progressPercent;
                progressText.textContent = `${progressPercent}%`;
            }
            
            // Update progress details
            const progressDetails = document.querySelector('.progress-details');
            if (progressDetails) {
                progressDetails.innerHTML = `
                    <p><strong>${totalTasks} Total Tasks</strong></p>
                    <p>${completedTasks} Completed ‚Ä¢ ${inProgressTasks + reviewTasks} In Progress</p>
                    <p>${totalTasks > 0 ? `${todoTasks} Remaining` : 'Ready to start!'}</p>
                `;
            }
            
            // Update activity timeline when tasks change
            updateActivityTimeline();
        }

        // Update activity timeline
        function updateActivityTimeline() {
            const timeline = document.querySelector('.activity-timeline');
            if (totalTasks === 0) {
                timeline.innerHTML = `
                    <div class="empty-activity">
                        <span class="empty-activity-icon">üì≠</span>
                        <span class="empty-activity-text">No recent activity</span>
                        <span class="empty-activity-desc">Start creating tasks to see activity here</span>
                    </div>
                `;
            } else {
                // You can add real activity tracking here
                timeline.innerHTML = `
                    <div class="activity-item">
                        <span class="activity-time">Just now</span>
                        <span class="activity-text">Workspace updated with ${totalTasks} tasks</span>
                    </div>
                `;
            }
        }

        // Timer Functions
        function showTimer() {
            document.getElementById('timerWidget').style.display = 'block';
        }

        function closeTimer() {
            if (timerRunning) {
                stopTimer();
            }
            document.getElementById('timerWidget').style.display = 'none';
        }

        function toggleTimer() {
            if (timerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                document.getElementById('timerControl').textContent = '‚è∏Ô∏è';
                
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                
                showNotification('Timer started!', 'success');
            }
        }

        function stopTimer() {
            if (timerRunning) {
                timerRunning = false;
                document.getElementById('timerControl').textContent = '‚ñ∂Ô∏è';
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                showNotification('Timer stopped!', 'info');
            }
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Style the notification
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '8px',
                color: 'white',
                fontSize: '14px',
                fontWeight: '500',
                zIndex: '10000',
                transform: 'translateX(400px)',
                transition: 'transform 0.3s ease-out',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)'
            });
            
            // Set background color based on type
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };
            
            notification.style.backgroundColor = colors[type] || colors.info;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Progress Circle Animation
        function animateProgressCircles() {
            const progressCircles = document.querySelectorAll('.progress-circle[data-progress]');
            
            progressCircles.forEach(circle => {
                const progress = parseInt(circle.dataset.progress);
                const progressText = circle.querySelector('.progress-text');
                
                if (progress === 100) {
                    circle.classList.add('completed');
                    if (progressText) {
                        progressText.textContent = '‚úì';
                    }
                } else {
                    // Add CSS custom property for progress
                    circle.style.setProperty('--progress', `${progress}%`);
                }
            });
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize TaskManager
            taskManager = new TaskManager();
            
            try {
                await taskManager.initialize();
                console.log('‚úÖ TaskManager initialized successfully');
                
                // Load existing tasks
                await loadAllTasks();
                
                // Initialize swipe-to-delete for all existing tasks
                document.querySelectorAll('.task-card').forEach(taskElement => {
                    initializeSwipeToDelete(taskElement);
                });
            } catch (error) {
                console.error('‚ùå TaskManager initialization failed:', error);
                showNotification('Working in offline mode', 'warning');
            }
            
            initializeViewToggle();
            initializeSearch();
            initializeQuickActions();
            animateProgressCircles();
            updateTaskCounts();
            updateProjectStats();
            checkEmptyState();
            
            // Initialize delete zone
            const deleteZone = document.getElementById('deleteZone');
            if (deleteZone) {
                deleteZone.addEventListener('dragover', allowDropOnDeleteZone);
                deleteZone.addEventListener('dragleave', dragLeaveDeleteZone);
                deleteZone.addEventListener('drop', dropOnDeleteZone);
            }
            
            // Add event listener to create task button as backup
            const createTaskBtn = document.querySelector('.btn-create');
            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Create task button clicked via event listener'); // Debug log
                    createTask();
                });
            }
            
            // Close modal when clicking outside
            document.getElementById('taskModalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'taskModalOverlay') {
                    closeTaskModal();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeTaskModal();
                    closeTimer();
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            openTaskModal('todo');
                            break;
                        case 't':
                            e.preventDefault();
                            showTimer();
                            break;
                        case 'Enter':
                            // Allow Enter key to submit form in modal
                            const modal = document.getElementById('taskModalOverlay');
                            if (modal.style.display === 'flex') {
                                e.preventDefault();
                                createTask();
                            }
                            break;
                        case 'r':
                            // Ctrl+R to refresh tasks
                            e.preventDefault();
                            loadAllTasks();
                            break;
                    }
                }
            });
            
            // Sync offline changes periodically
            setInterval(async () => {
                if (taskManager && taskManager.isOnline) {
                    await taskManager.syncOfflineChanges();
                }
            }, 30000); // Every 30 seconds
            
            showNotification('Welcome to your enhanced WorkSpace! ‚ú®', 'success');
        });

        // Add some CSS animations via JavaScript
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                0% { transform: translateX(0); opacity: 1; }
                100% { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes taskDropped {
                0% { transform: scale(1.05); }
                50% { transform: scale(0.95); }
                100% { transform: scale(1); }
            }
            
            .task-dropped {
                animation: taskDropped 0.3s ease-out;
            }
            
            .progress-circle {
                position: relative;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: conic-gradient(#667eea var(--progress, 0%), #f0f0f0 var(--progress, 0%));
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }
            
            .progress-circle::before {
                content: '';
                position: absolute;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: white;
            }
            
            .progress-text {
                position: relative;
                z-index: 1;
                font-size: 10px;
                font-weight: 600;
                color: #333;
            }
            
            .progress-circle.completed {
                background: conic-gradient(#28a745 100%, #28a745 100%);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>
